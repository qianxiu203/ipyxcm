name: Final Test - IP Optimizer

on:
  workflow_dispatch:
    inputs:
      country:
        description: 'ç›®æ ‡å›½å®¶ä»£ç '
        required: false
        default: 'US'
        type: string
      count:
        description: 'ç›®æ ‡IPæ•°é‡'
        required: false
        default: '3'
        type: string

jobs:
  test-ip-optimizer:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp requests
        
    - name: Test network connectivity
      run: |
        echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥..."
        curl -I --connect-timeout 5 https://1.1.1.1/dns-query || echo "Cloudflare DNS API è¿æ¥å¤±è´¥"
        curl -I --connect-timeout 5 https://www.cloudflare.com || echo "Cloudflare ç½‘ç«™è¿æ¥å¤±è´¥"
        
    - name: Run IP optimizer (small test)
      run: |
        echo "ğŸ§ª è¿è¡Œå°è§„æ¨¡æµ‹è¯•..."
        python ip_optimizer.py \
          --country "${{ github.event.inputs.country || 'US' }}" \
          --count "${{ github.event.inputs.count || '3' }}" \
          --port 443 \
          --max-ips 20 \
          --concurrent 4 \
          --output "test_nodes.txt"
      env:
        PYTHONUNBUFFERED: 1
        PYTHONIOENCODING: utf-8
        GITHUB_ACTIONS: true
        
    - name: Verify results
      run: |
        if [ -f "test_nodes.txt" ]; then
          echo "âœ… æµ‹è¯•æˆåŠŸï¼ç”Ÿæˆçš„èŠ‚ç‚¹æ–‡ä»¶:"
          echo "æ–‡ä»¶å¤§å°: $(wc -l < test_nodes.txt) è¡Œ"
          echo "å†…å®¹é¢„è§ˆ:"
          cat test_nodes.txt
        else
          echo "âŒ æœªç”ŸæˆèŠ‚ç‚¹æ–‡ä»¶"
          exit 1
        fi
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: test-nodes-${{ github.event.inputs.country || 'US' }}
        path: test_nodes.txt
        retention-days: 7
