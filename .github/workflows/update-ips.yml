name: Update Cloudflare IPs

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write
  actions: read
  issues: write
  pull-requests: write

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼ˆUTC 0ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      country:
        description: 'ç›®æ ‡å›½å®¶ä»£ç '
        required: false
        default: 'US,JP,SG,KR'
        type: string
      count:
        description: 'ç›®æ ‡IPæ•°é‡'
        required: false
        default: '6'
        type: string
      port:
        description: 'ç›®æ ‡ç«¯å£'
        required: false
        default: '443'
        type: string
      max_ips:
        description: 'æ¯ä¸ªåº“æœ€å¤§IPæ•°é‡'
        required: false
        default: '512'
        type: string

jobs:
  update-ips:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp
        pip install requests  # å¤‡ç”¨HTTPåº“

    - name: Test network connectivity
      run: |
        echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥..."
        echo "Testing DNS resolution..."
        nslookup 1.1.1.1 || echo "DNS resolution failed"
        echo "Testing HTTP connectivity..."
        curl -I --connect-timeout 5 https://1.1.1.1/dns-query || echo "Cloudflare DNS API è¿æ¥å¤±è´¥"
        curl -I --connect-timeout 5 https://www.cloudflare.com || echo "Cloudflare ç½‘ç«™è¿æ¥å¤±è´¥"
        
    - name: Set parameters
      id: params
      run: |
        # è®¾ç½®é»˜è®¤å‚æ•°
        COUNTRY="${{ github.event.inputs.country || 'CN' }}"
        COUNT="${{ github.event.inputs.count || '10' }}"
        PORT="${{ github.event.inputs.port || '443' }}"
        MAX_IPS="${{ github.event.inputs.max_ips || '512' }}"

        echo "country=$COUNTRY" >> $GITHUB_OUTPUT
        echo "count=$COUNT" >> $GITHUB_OUTPUT
        echo "port=$PORT" >> $GITHUB_OUTPUT
        echo "max_ips=$MAX_IPS" >> $GITHUB_OUTPUT

        echo "Parameters set:"
        echo "Country: $COUNTRY"
        echo "Count: $COUNT"
        echo "Port: $PORT"
        echo "Max IPs per source: $MAX_IPS"
        
    - name: Run IP optimizer
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡ŒIPä¼˜é€‰è„šæœ¬..."
        echo "å‚æ•°: å›½å®¶=${{ steps.params.outputs.country }}, æ•°é‡=${{ steps.params.outputs.count }}, ç«¯å£=${{ steps.params.outputs.port }}"

        python ip_optimizer.py \
          --country "${{ steps.params.outputs.country }}" \
          --count "${{ steps.params.outputs.count }}" \
          --port "${{ steps.params.outputs.port }}" \
          --max-ips 50 \
          --concurrent 8 \
          --output "nodes.txt"
      env:
        PYTHONUNBUFFERED: 1
        PYTHONIOENCODING: utf-8
        GITHUB_ACTIONS: true
          
    - name: Check if nodes.txt was created
      run: |
        if [ -f "nodes.txt" ]; then
          echo "nodes.txt created successfully"
          echo "File size: $(wc -l < nodes.txt) lines"
          echo "First 5 lines:"
          head -5 nodes.txt
        else
          echo "nodes.txt was not created"
          exit 1
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet nodes.txt; then
          echo "No changes to commit"
        else
          git add nodes.txt
          git commit -m "Auto update nodes.txt - ${{ steps.params.outputs.count }} ${{ steps.params.outputs.country }} IPs ($(date '+%Y-%m-%d %H:%M:%S'))"
          git push
          echo "Changes committed and pushed"
        fi
        
    - name: Create release (optional)
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nodes-${{ steps.params.outputs.country }}-${{ github.run_number }}
        name: ${{ steps.params.outputs.country }} Nodes - ${{ github.run_number }}
        body: |
          è‡ªåŠ¨æ›´æ–°çš„ ${{ steps.params.outputs.country }} å›½å®¶ Cloudflare IP èŠ‚ç‚¹åˆ—è¡¨

          **å‚æ•°ä¿¡æ¯:**
          - å›½å®¶: ${{ steps.params.outputs.country }}
          - ç›®æ ‡æ•°é‡: ${{ steps.params.outputs.count }}
          - ç«¯å£: ${{ steps.params.outputs.port }}
          - æ¯åº“æœ€å¤§IPæ•°: 50
          - æ›´æ–°æ—¶é—´: ${{ github.run_id }}

          **æ–‡ä»¶è¯´æ˜:**
          - `nodes.txt`: åŒ…å«ä¼˜é€‰çš„IPèŠ‚ç‚¹åˆ—è¡¨ï¼ŒæŒ‰å»¶è¿Ÿæ’åº
          - è„šæœ¬éå†æ‰€æœ‰IPåº“ç›´åˆ°æ‰¾åˆ°æŒ‡å®šæ•°é‡çš„ç›®æ ‡å›½å®¶IP
        files: nodes.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload nodes.txt as artifact
      uses: actions/upload-artifact@v4
      with:
        name: nodes-${{ steps.params.outputs.country }}-${{ steps.params.outputs.count }}
        path: nodes.txt
        retention-days: 30
        
    - name: Summary
      run: |
        echo "## ğŸ‰ IPä¼˜é€‰å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š è¿è¡Œå‚æ•°" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡å›½å®¶**: ${{ steps.params.outputs.country }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡æ•°é‡**: ${{ steps.params.outputs.count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç«¯å£**: ${{ steps.params.outputs.port }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¯åº“æœ€å¤§IPæ•°**: ${{ steps.params.outputs.max_ips }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "nodes.txt" ]; then
          NODE_COUNT=$(wc -l < nodes.txt)
          echo "### ğŸ“‹ ç»“æœç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **è·å–èŠ‚ç‚¹æ•°**: $NODE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶å¤§å°**: $(du -h nodes.txt | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ” å‰5ä¸ªæœ€ä¼˜èŠ‚ç‚¹" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -5 nodes.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          echo "æœªèƒ½ç”ŸæˆèŠ‚ç‚¹æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
